<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Andy Wegner" />

        <meta property="og:type" content="article" />

<meta name="keywords" content="technical, Technical Solutions, " />

<meta property="og:title" content="Setting up a ZFS pool on Ubuntu 16.04 "/>
<meta property="og:url" content="http://andrewwegner.com/zfs-pool-on-ubuntu.html" />
<meta property="og:description" content="With the backup server assembled, it&#39;s time to start configuring it. This post covers setting up the ZFS pool for all the data" />
<meta property="og:site_name" content="Ponderings of an Andy" />
<meta property="og:article:author" content="Andy Wegner" />
<meta property="og:article:published_time" content="2018-02-15T22:30:00-06:00" />
<meta name="twitter:title" content="Setting up a ZFS pool on Ubuntu 16.04 ">
<meta name="twitter:description" content="With the backup server assembled, it&#39;s time to start configuring it. This post covers setting up the ZFS pool for all the data">

        <title>Setting up a ZFS pool on Ubuntu 16.04  · Ponderings of an Andy
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://andrewwegner.com/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://andrewwegner.com/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://andrewwegner.com/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://andrewwegner.com/theme/css/custom.css" media="screen">
		<link rel="stylesheet" type="text/css" href="http://andrewwegner.com/theme/css/keys.css" media="screen">
        <link href="http://andrewwegner.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Ponderings of an Andy - Full Atom Feed" />
        <script type="text/javascript">
            window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
              heap.load("653100411");
        </script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="http://andrewwegner.com/"><span class=site-name>Ponderings of an Andy</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://andrewwegner.com">Home</a></li>
                            <li ><a href="http://andrewwegner.com/categories.html">Categories</a></li>
                            <li ><a href="http://andrewwegner.com/tags.html">Tags</a></li>
                            <li ><a href="http://andrewwegner.com/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://andrewwegner.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article itemscope itemtype="http://schema.org/BlogPosting">
<meta itemprop="headline" content="Setting up a ZFS pool on Ubuntu 16.04" />
<time itemprop="datePublished" datetime="2018-02-15T22:30:00-06:00">
<meta itemprop="publisher" content="Andy Wegner" />
<link rel="canonical" href="http://andrewwegner.com/zfs-pool-on-ubuntu.html" />
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="http://andrewwegner.com/zfs-pool-on-ubuntu.html"> Setting up a ZFS pool on Ubuntu 16.04  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#installing-zfs">Installing ZFS</a></li>
<li><a href="#setting-up-our-pool">Setting up our pool</a><ul>
<li><a href="#adding-the-gpt-label">Adding the GPT label</a></li>
<li><a href="#getting-device-ids">Getting device IDs</a></li>
<li><a href="#create-the-pool">Create the pool</a></li>
</ul>
</li>
<li><a href="#create-datasets">Create datasets</a></li>
<li><a href="#set-up-complete">Set up complete</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            
            <div itemprop="articleBody mainEntityOfPage">
            
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">¶</a></h2>
<p><a href="http://andrewwegner.com/new-house-server.html">Previously</a> in this series, the new NAS was assembled. Ubuntu 16.04 has been installed and updated. It's time to do something with all those hard drives! </p>
<p>I'll be setting the seven 4TB drives in a single <a href="https://en.wikipedia.org/wiki/ZFS">ZFS</a> pool. I'm using ZFS for protection against data corruption. It offers several other <a href="https://wiki.ubuntu.com/ZFS">features</a> too. I'll
be using dual parity, which means I could lose two drives and be able to recover. The goal is never to test this, but I'd rather not go through a <a href="http://andrewwegner.com/backup-your-data.html">data loss scare</a> again.</p>
<p>Before we begin, it's a good idea to ensure Ubuntu has been updated.</p>
<div class="codehilight code"><pre><span></span>sudo apt-get update &amp;&amp; sudo apt-get upgrade
</pre></div>
<p>With the update complete, let's get started. </p>
<h2 id="installing-zfs">Installing ZFS<a class="headerlink" href="#installing-zfs" title="Permanent link">¶</a></h2>
<p>Installing the ZFS file system is simple on Ubuntu. </p>
<div class="codehilight code"><pre><span></span>sudo apt-get install zfs parted
</pre></div>
<p>Ta-da! Your system is now capable of setting up ZFS pools. The <code>parted</code> package will be used to set up a ZFS pool shortly.</p>
<h2 id="setting-up-our-pool">Setting up our pool<a class="headerlink" href="#setting-up-our-pool" title="Permanent link">¶</a></h2>
<p>Pools are the basic building block of ZFS. A pool is made up of the underlying devices that will store the data. Setting up our ZFS pool requires a little bit of prep work
for our new drives. First, ensure that the <code>zfs</code> package installed correctly by running:</p>
<div class="codehilight code"><pre><span></span>sudo zpool status
</pre></div>
<p>At this point in the process, you should get the message <code>no pools available</code>. </p>
<h3 id="adding-the-gpt-label">Adding the GPT label<a class="headerlink" href="#adding-the-gpt-label" title="Permanent link">¶</a></h3>
<p>I'm setting up this pool with brand new drives. We need to add a <code>GPT</code> label to each disk so that ZFS doesn't complain about disks having an <code>invalid vdev specification</code> 
when we create the pool. To do this, we'll find the names of our drives first</p>
<div class="codehilight code"><pre><span></span>ls -l /dev/sd*
</pre></div>
<p>On my system, I get a result similar to this:</p>
<div class="codehilight code"><pre><span></span>brw-rw---- 1 root disk 8,   0 Feb 13 09:23 /dev/sda
brw-rw---- 1 root disk 8,   1 Feb 13 09:23 /dev/sda1
brw-rw---- 1 root disk 8,   2 Feb 13 09:23 /dev/sda2
brw-rw---- 1 root disk 8,   5 Feb 13 09:23 /dev/sda5
brw-rw---- 1 root disk 8,  16 Feb 13 09:23 /dev/sdb
brw-rw---- 1 root disk 8,  32 Feb 13 09:23 /dev/sdc
brw-rw---- 1 root disk 8,  48 Feb 13 09:23 /dev/sdd
brw-rw---- 1 root disk 8,  64 Feb 13 09:23 /dev/sde
brw-rw---- 1 root disk 8,  80 Feb 13 09:23 /dev/sdf
brw-rw---- 1 root disk 8,  96 Feb 13 09:23 /dev/sdg
brw-rw---- 1 root disk 8, 112 Feb 13 09:23 /dev/sdh
</pre></div>
<p>We'll be adding the <code>GPT</code> labels to each of the unformatted drives. The unformatted ones are the listed drives that don't have a numeral as well. For me, that means we'll
be working with <code>sdb</code>, <code>sdc</code>, <code>sdd</code>, <code>sde</code>, <code>sdf</code>, <code>sdg</code> and <code>sdh</code>. The <code>sda</code> drive has been formatted and contains partitions already. Those are <code>sda1</code>, <code>sda2</code> and <code>sda5</code>. </p>
<p>For each drive, except <code>sda</code> in my case, we need to run the <code>parted</code> command.</p>
<div class="codehilight code"><pre><span></span>sudo parted /dev/sdb
</pre></div>
<p>This will give you a short dialog. All you will need to do is issue the <code>mklabel GPT</code> command and then quit (using <code>q</code>)</p>
<div class="codehilight code"><pre><span></span>GNU Parted 3.2
Using /dev/sdb
Welcome to GNU Parted! Type 'help' to view a list of commands.
(parted) mklabel GPT
(parted) q
Information: You may need to update /etc/fstab.
</pre></div>
<h3 id="getting-device-ids">Getting device IDs<a class="headerlink" href="#getting-device-ids" title="Permanent link">¶</a></h3>
<p>Once the <code>GPT</code> labels are added, we can create our pool. However, we're not going to use the device paths returned above. Theoretically, those can change (especially if you 
replace a drive). That would be bad and mess with the entire ZFS pool. Instead we're going to create the pool by using the device id. </p>
<div class="codehilight code"><pre><span></span>ls -l /dev/disk/by-id/*
</pre></div>
<p>This returns output similar to this:</p>
<div class="codehilight code"><pre><span></span>...
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/wwn-0x50014ee20f1d3114 -&gt; ../../sdc
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/wwn-0x50014ee20f3ba2b9 -&gt; ../../sdg
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/wwn-0x50014ee2647227b7 -&gt; ../../sdb
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/wwn-0x50014ee26490a21e -&gt; ../../sdd
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/wwn-0x50014ee2b9c81501 -&gt; ../../sdh
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/wwn-0x50014ee2b9e6ab61 -&gt; ../../sdf
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/wwn-0x50014ee2b9e6b857 -&gt; ../../sde
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/wwn-0x5001b444a9525c87 -&gt; ../../sda
lrwxrwxrwx 1 root root 10 Feb 13 09:23 /dev/disk/by-id/wwn-0x5001b444a9525c87-part1 -&gt; ../../sda1
lrwxrwxrwx 1 root root 10 Feb 13 09:23 /dev/disk/by-id/wwn-0x5001b444a9525c87-part2 -&gt; ../../sda2
lrwxrwxrwx 1 root root 10 Feb 13 09:23 /dev/disk/by-id/wwn-0x5001b444a9525c87-part5 -&gt; ../../sda5

...
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/ata-WDC_WD40EFRX-68N32N0_WD-WCC7K0HLKUXT -&gt; ../../sdb
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/ata-WDC_WD40EFRX-68N32N0_WD-WCC7K0HLKXS0 -&gt; ../../sdc
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/ata-WDC_WD40EFRX-68N32N0_WD-WCC7K4YJ6T0U -&gt; ../../sdg
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/ata-WDC_WD40EFRX-68N32N0_WD-WCC7K5LCEYN4 -&gt; ../../sdf
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/ata-WDC_WD40EFRX-68N32N0_WD-WCC7K6VNN6TA -&gt; ../../sde
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/ata-WDC_WD40EFRX-68N32N0_WD-WCC7K6VNNTXY -&gt; ../../sdd
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/ata-WDC_WD40EFRX-68N32N0_WD-WCC7K7TSA4VS -&gt; ../../sdh
lrwxrwxrwx 1 root root  9 Feb 13 09:23 /dev/disk/by-id/ata-WDC_WDS100T1B0A-00H9H0_174256421671 -&gt; ../../sda
lrwxrwxrwx 1 root root 10 Feb 13 09:23 /dev/disk/by-id/ata-WDC_WDS100T1B0A-00H9H0_174256421671-part1 -&gt; ../../sda1
lrwxrwxrwx 1 root root 10 Feb 13 09:23 /dev/disk/by-id/ata-WDC_WDS100T1B0A-00H9H0_174256421671-part2 -&gt; ../../sda2
lrwxrwxrwx 1 root root 10 Feb 13 09:23 /dev/disk/by-id/ata-WDC_WDS100T1B0A-00H9H0_174256421671-part5 -&gt; ../../sda5
</pre></div>
<p>Notice that both formats symlink to the same location. This means you can pick which ever format you like better. However, I recommend the second one that contains the 
device serial number. It'll make it easier to determine problem disks in the future. </p>
<h3 id="create-the-pool">Create the pool<a class="headerlink" href="#create-the-pool" title="Permanent link">¶</a></h3>
<p>Now that we've determined the device ides for each of our hard drives, it's time to actually create the pool. As I mentioned above, we'll be creating using dual parity
(<code>raidz2</code>). We'll be naming our pool <code>data</code>. Once this command is complete, <code>/data</code> will be where this pool resides.</p>
<div class="codehilight code"><pre><span></span>sudo zpool create data raidz2 /dev/disk/by-id/ata-WDC_WD40EFRX-68N32N0_WD-WCC7K0HLKUXT /dev/disk/by-id/ata-WDC_WD40EFRX-68N32N0_WD-WCC7K0HLKXS0 /dev/disk/by-id/ata-WDC_WD40EFRX-68N32N0_WD-WCC7K6VNNTXY /dev/disk/by-id/ata-WDC_WD40EFRX-68N32N0_WD-WCC7K6VNN6TA /dev/disk/by-id/ata-WDC_WD40EFRX-68N32N0_WD-WCC7K5LCEYN4 /dev/disk/by-id/ata-WDC_WD40EFRX-68N32N0_WD-WCC7K4YJ6T0U /dev/disk/by-id/ata-WDC_WD40EFRX-68N32N0_WD-WCC7K7TSA4VS
</pre></div>
<p>This will take a little while, but a surprisingly smaller amount of time than I initially expected. </p>
<p>Once the creation is complete, take a look at the status of your new pool:</p>
<div class="codehilight code"><pre><span></span>sudo zpool status

  pool: data
 state: ONLINE
  scan: none requested
config:

        NAME                                          STATE     READ WRITE CKSUM
        data                                          ONLINE       0     0     0
          raidz2-0                                    ONLINE       0     0     0
            ata-WDC_WD40EFRX-68N32N0_WD-WCC7K0HLKUXT  ONLINE       0     0     0
            ata-WDC_WD40EFRX-68N32N0_WD-WCC7K0HLKXS0  ONLINE       0     0     0
            ata-WDC_WD40EFRX-68N32N0_WD-WCC7K6VNNTXY  ONLINE       0     0     0
            ata-WDC_WD40EFRX-68N32N0_WD-WCC7K6VNN6TA  ONLINE       0     0     0
            ata-WDC_WD40EFRX-68N32N0_WD-WCC7K5LCEYN4  ONLINE       0     0     0
            ata-WDC_WD40EFRX-68N32N0_WD-WCC7K4YJ6T0U  ONLINE       0     0     0
            ata-WDC_WD40EFRX-68N32N0_WD-WCC7K7TSA4VS  ONLINE       0     0     0

errors: No known data errors
</pre></div>
<p>That last line is important. No known data errors is good. </p>
<h2 id="create-datasets">Create datasets<a class="headerlink" href="#create-datasets" title="Permanent link">¶</a></h2>
<p>Where pools are the basic building blocks of ZFS, datasets is a term for a ZFS file system, volume, snapshot or clone. Each dataset can be managed and configured differently.
This means that you can compress one dataset, but leave the others alone. You can put a quota on one, but leave the others without a quota. Creating a dataset is pretty easy:</p>
<div class="codehilight code"><pre><span></span>cd /
sudo zfs create data/storage
</pre></div>
<p>This will create a dataset that exists at <code>/data</code> named <code>storage</code>. You can have child datasets that inherit attributes from parents (or even grandparents) by doing something
like:</p>
<div class="codehilight code"><pre><span></span>sudo zfs create data/storage/music
</pre></div>
<p>This will create the new dataset at <code>/data/storage</code> named <code>music</code>.</p>
<p>Once you've set up your datasets, you can see they were all created and how much space they have available by issuing <code>sudo zfs list</code>.</p>
<h2 id="set-up-complete">Set up complete<a class="headerlink" href="#set-up-complete" title="Permanent link">¶</a></h2>
<p>With that, we've finished setting up ZFS on Ubuntu 16.04. I set up a few datasets for my purposes. I'm one step closer to getting this running and handling all of the 
digital data in the house. </p>
            </div>
            <hr />
            <div itemprop="author creator" itemscope itemtype="http://schema.org/Person">
                    <span class="author_blurb"><a itemprop="url" href="http://andrewwegner.com/" rel="author"><span class="author_name" itemprop="name">Andy Wegner</span></a> -
             is a father, an engineer and a computer scientist. He is interested in online 
            community building, tinkering with new code and building new applications. 
            He writes about his experiences with each of these.</span>

            </div>
            
            
            <hr/>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="http://andrewwegner.com/new-house-server.html" title="Previous: ...and then there was a backup server">...and then there was a backup server</a></li>
                <li class="next-article"><a href="http://andrewwegner.com/django-course-basic-to-advance.html" title="Next: Review of Udemy&#39;s Django Course from Basics to Advance">Review of Udemy's Django Course from Basics to Advance</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2018-02-15T22:30:00-06:00">Feb 15, 2018</time>
<time itemprop="dateModified" datetime="2018-02-15T22:30:00-06:00">

        <h4>Recovering from data loss</h4>
    <ul class="multi-parts-list">
            <li >
            <a href="http://andrewwegner.com/backup-your-data.html" title="Well, there goes my data...">Part 1: Well, there goes my data...</a>
            </li>
            <li >
            <a href="http://andrewwegner.com/new-house-server.html" title="...and then there was a backup server">Part 2: ...and then there was a backup server</a>
            </li>
            <li  class="active-part">
            Part 3: Setting up a ZFS pool on Ubuntu 16.04
            </li>
            <li >
            <a href="http://andrewwegner.com/Installing NextCloud.html" title="Setting up a ZFS pool on Ubuntu 16.04">Part 4: Setting up a ZFS pool on Ubuntu 16.04</a>
            </li>
    </ul>
            <h4>Category</h4>
            <a class="category-link" href="http://andrewwegner.com/categories.html#technical-solutions-ref">Technical Solutions</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="http://andrewwegner.com/tags.html#technical-ref">technical
                    <span>21</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="http://stackoverflow.com/users/189134/andy" title="My Stack Overflow Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-stack-overflow sidebar-social-links"></i></a>
    <a href="http://steamcommunity.com/id/InsaneMosquito/" title="My Steam Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-steam-square sidebar-social-links"></i></a>
    <a href="http://stackoverflow.com/cv/andrewwegner" title="My Stack Overflow Jobs Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-stack-overflow sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a> Modified by <a href="http://www.andrewwegner.com" title="Andrew Wegner Home Page">Andy Wegner</a></li>
    </ul>
</div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="https://use.fontawesome.com/e4a49a2d36.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    
    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>