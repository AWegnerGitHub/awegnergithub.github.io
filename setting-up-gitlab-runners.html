
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />


  <link rel="canonical" href="https://andrewwegner.com/setting-up-gitlab-runners.html">

  <meta name="robots" content="index, follow" />

  <link
    href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=block"
    rel="stylesheet">

  <link rel="stylesheet" type="text/css" href="https://andrewwegner.com/theme/stylesheet/style.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://andrewwegner.com/theme/font-awesome/css/font-awesome-v4.css">


  <link id="pygments-light-theme" rel="stylesheet" type="text/css"     href="https://andrewwegner.com/theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="https://andrewwegner.com/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://andrewwegner.com/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://andrewwegner.com/theme/font-awesome/css/solid.css">


<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" sizes="180x180" href=" /apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">

  <!-- Chrome, Firefox OS and Opera -->
  <meta name="theme-color" content="#080019">
  <!-- Windows Phone -->
  <meta name="msapplication-navbutton-color" content="#080019">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Microsoft EDGE -->
  <meta name="msapplication-TileColor" content="#080019">

  <link href="https://andrewwegner.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Ponderings of an Andy Atom">


<script type="text/javascript">
    window.heap = window.heap || [], heap.load = function (e, t) { window.heap.appid = e, window.heap.config = t = t || {}; var r = t.forceSSL || "https:" === document.location.protocol, a = document.createElement("script"); a.type = "text/javascript", a.async = !0, a.src = (r ? "https:" : "http:") + "//cdn.heapanalytics.com/js/heap-" + e + ".js"; var n = document.getElementsByTagName("script")[0]; n.parentNode.insertBefore(a, n); for (var o = function (e) { return function () { heap.push([e].concat(Array.prototype.slice.call(arguments, 0))) } }, p = ["addEventProperties", "addUserProperties", "clearEventProperties", "identify", "resetIdentity", "removeEventProperty", "setEventProperties", "track", "unsetEventProperty"], c = 0; c < p.length; c++)heap[p[c]] = o(p[c]) };
    heap.load("653100411");
</script>

<meta name="author" content="Andy Wegner" />
<meta name="description" content="How I set up a GitLab runner" />
<meta name="keywords" content="technical, gitlab">


  <meta property="og:site_name" content="Ponderings of an Andy"/>
  <meta property="og:title" content="Setting up GitLab runners"/>
  <meta property="og:description" content="How I set up a GitLab runner"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://andrewwegner.com/setting-up-gitlab-runners.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2019-10-22 11:00:00-05:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="https://andrewwegner.com/">
  <meta property="article:section" content="Technical Solutions"/>
  <meta property="article:tag" content="technical"/>
  <meta property="article:tag" content="gitlab"/>
  <meta property="og:image" content="/images/wegner_headshot.png">

  <title>Setting up GitLab runners  · Ponderings of an Andy
</title>

</head>

<body class="light-theme" >

<aside class="aside-border">
  <div class="aside-cont">
<a href="https://andrewwegner.com/">
    <img class="hex-logo" src="/images/wegner_headshot.png" alt="Ponderings of an Andy" title="Ponderings of an Andy">
</a>

    <nav id="nav-links">
      <ul class="list">



        <li>
          <a target="_self" href="/">Home</a>
        </li>
        <li>
          <a target="_self" href="/about/">About Me</a>
        </li>
        <li>
          <a target="_self" href="/archives.html">Archives</a>
        </li>
        <li>
          <a target="_self" href="/categories.html">Categories</a>
        </li>
        <li>
          <a target="_self" href="/tags.html">Tags</a>
        </li>
      </ul>
    </nav>

    <h3>Article Contents</h3>
    <hr />
    <nav class="toc">
      <div class="toc">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#set-up">Set up</a><ul>
<li><a href="#docker">Docker</a></li>
<li><a href="#gitlab-runner">GitLab Runner</a></li>
</ul>
</li>
<li><a href="#using-the-cicd-pipeline">Using the CI/CD pipeline</a><ul>
<li><a href="#static-analysis">Static Analysis</a></li>
<li><a href="#test">Test</a></li>
<li><a href="#deploy-testing">Deploy Testing</a></li>
<li><a href="#deploy-production">Deploy Production</a></li>
</ul>
</li>
<li><a href="#environment-set-up">Environment set up</a><ul>
<li><a href="#gitlab-ciyml">.gitlab-ci.yml</a></li>
</ul>
</li>
<li><a href="#gitlab-ciyml-explanation">.gitlab-ci.yml explanation</a><ul>
<li><a href="#tags">Tags</a></li>
<li><a href="#allow-failures">Allow failures</a></li>
<li><a href="#manual-deployment">Manual deployment</a></li>
</ul>
</li>
<li><a href="#next-steps">Next Steps</a></li>
</ul>
</div>
    </nav>

<ul class="social">
  <div class="itsmefooter">Andy Wegner</div>
  <li>
    <a id="andy-linkedin" class="sc-linkedin" rel="me"  href="https://www.linkedin.com/in/andrew-wegner/"
      target="_blank">
      <i class="fa-brands fa-linkedin"></i>
    </a>
  </li>
  <li>
    <a id="andy-stackoverflow" class="sc-stack-overflow" rel="me"  href="https://stackoverflow.com/users/189134/andy"
      target="_blank">
      <i class="fa-brands fa-stack-overflow"></i>
    </a>
  </li>
  <li>
    <a id="andy-github" class="sc-github" rel="me"  href="https://github.com/AWegnerGitHub/"
      target="_blank">
      <i class="fa-brands fa-github"></i>
    </a>
  </li>
  <li>
    <a id="andy-resume" class="sc-file-pdf"  href="/resume.pdf"
      target="_blank">
      <i class="fa-solid fa-file-pdf"></i>
    </a>
  </li>
  <li>
    <a id="andy-blogemail" class="sc-envelope" rel="me"  href="mailto:blog.feedback@andrewwegner.com"
      target="_blank">
      <i class="fa-solid fa-envelope"></i>
    </a>
  </li>
</ul>
  </div>

  <script type="text/javascript">

    let acont = document.getElementsByClassName("toc content-cont")[0];
    function back(){
      acont.style.left = "-24vw";
    }
    function openCont(){
      acont.style.left = "-1vw";
    }
  </script>
</aside>
  <main>

<article class="single">
  <header>
    
<nav>
    <ul class="article-breadcrumbs">
        <li><a href="/"><i class="fa-sharp fa-solid fa-house"></i>&nbsp;Home</a></li>
        <li><i class="fa-solid fa-greater-than"></i>&nbsp;<a href="https://andrewwegner.com/categories.html">Categories</a></li>
        <li><i class="fa-solid fa-greater-than"></i>&nbsp;<a href="https://andrewwegner.com/category/technical-solutions.html">Technical Solutions</a>
        </li>
        <li><i class="fa-solid fa-greater-than"></i>&nbsp;<a href="https://andrewwegner.com/setting-up-gitlab-runners.html"><i
                    class="fa-solid fa-book"></i>&nbsp;<span class="breadcrumb-article">Setting up GitLab runners</span></li></a></li>
    </ul>
</nav>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
  {
    "@type": "ListItem",
    "position": 1,
    "item": 
    {
      "@id": "/",
      "name": "Ponderings of an Andy"
    }
  },
  {
    "@type": "ListItem",
    "position": 2,
    "item": 
    {
      "@id": "https://andrewwegner.com/categories.html",
      "name": "Categories"
    }
  }
  ,{
    "@type": "ListItem",
    "position": 3,
    "item": 
    {
      "@id": "https://andrewwegner.com/category/technical-solutions.html",
      "name": "Technical Solutions"
    }
  }
  ,{
    "@type": "ListItem",
    "position": 4,
    "item": 
    {
      "@id": "https://andrewwegner.com/setting-up-gitlab-runners.html",
      "name": "https://andrewwegner.com/setting-up-gitlab-runners.html"
    }
  }
  ]
}
</script>    <h1 id="setting-up-gitlab-runners">Setting up GitLab runners</h1>
    <p>
      Posted on Tue 22 October 2019 in <a href="https://andrewwegner.com/category/technical-solutions.html">Technical Solutions</a>


    <div class="tag-cloud">
      <p>
        <a href="https://andrewwegner.com/tag/technical.html">technical</a>
        <a href="https://andrewwegner.com/tag/gitlab.html">gitlab</a>
      </p>
    </div>
    </p>
  </header>

  <div>
    
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">¶</a></h2>
<p>It's been a year and a half since I set up GitLab. In that time I've used to it
store my personal code, keep track of features I want to add to my own projects,
and generally loved it. One thing I haven't done though, is play with the CI/CD
features. I've been wanting to, but never got around to it.</p>
<p>To utilize the CI/CD features, you need to set up a <a href="https://docs.gitlab.com/runner/">GitLab runner</a></p>
<h2 id="set-up">Set up<a class="headerlink" href="#set-up" title="Permanent link">¶</a></h2>
<h3 id="docker">Docker<a class="headerlink" href="#docker" title="Permanent link">¶</a></h3>
<p>I'll be running my runners in <a href="https://www.docker.com/">Docker</a> containers. There are other options,
but for my home environment, this is easiest to set up and maintain.</p>
<p>Let's start by installing Docker:</p>
<div class="codehilight code"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="n">transport</span><span class="o">-</span><span class="n">https</span><span class="w"> </span><span class="n">ca</span><span class="o">-</span><span class="n">certificates</span><span class="w"> </span><span class="n">curl</span><span class="w"> </span><span class="n">software</span><span class="o">-</span><span class="n">properties</span><span class="o">-</span><span class="n">common</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
<span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">fsSL</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">docker</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">ubuntu</span><span class="o">/</span><span class="n">gpg</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="n">key</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">-</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span><span class="w"> </span><span class="s2">"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="w"> </span><span class="n">update</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">ce</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
</code></pre></div>
<p>This is going to add the Docker repository and install the community edition.</p>
<h3 id="gitlab-runner">GitLab Runner<a class="headerlink" href="#gitlab-runner" title="Permanent link">¶</a></h3>
<p>Once Docker is installed and working, we can install the GitLab runner.</p>
<div class="codehilight code"><pre><span></span><code><span class="n">wget</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span><span class="o">-</span><span class="n">downloads</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span><span class="n">binaries</span><span class="o">/</span><span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span>
<span class="n">chmod</span><span class="w"> </span><span class="o">+</span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span>
<span class="n">useradd</span><span class="w"> </span><span class="o">--</span><span class="n">comment</span><span class="w"> </span><span class="s1">'GitLab Runner'</span><span class="w"> </span><span class="o">--</span><span class="n">create</span><span class="o">-</span><span class="n">home</span><span class="w"> </span><span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span><span class="w"> </span><span class="o">--</span><span class="n">shell</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span><span class="w"> </span><span class="o">--</span><span class="n">working</span><span class="o">-</span><span class="n">directory</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span>
<span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span><span class="w"> </span><span class="n">start</span>
</code></pre></div>
<p>This is downloading the install package. Then it adds a new user, that the runner will run as. This is a nice security precaution to limit what the runner has access to on the system. It's not full security, but it does all me to restrict what that particular user has access to on the server.</p>
<p>Then the run is started.</p>
<p>Next the runner needs to be registered. Log into GitLab, and navigate to
the project that will be using this runner. It should be available at this link:</p>
<div class="codehilight code"><pre><span></span><code>https://url.to.your.gitlab.install/&lt;account&gt;/&lt;repo&gt;/settings/ci_cd
</code></pre></div>
<p>Grab the GitLab CI token. That is needed in the next step. Run the <code>gitlab-runner register</code> command, and fill in your values as required.</p>
<div class="codehilight code"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span><span class="w"> </span><span class="n">register</span>
<span class="n">Please</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">gitlab</span><span class="o">-</span><span class="n">ci</span><span class="w"> </span><span class="n">coordinator</span><span class="w"> </span><span class="n">URL</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">gitlab</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="p">)</span><span class="err">:</span>
<span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">url</span><span class="p">.</span><span class="k">to</span><span class="p">.</span><span class="n">your</span><span class="p">.</span><span class="n">gitlab</span><span class="p">.</span><span class="n">install</span><span class="o">/</span>

<span class="n">Please</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">gitlab</span><span class="o">-</span><span class="n">ci</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="nl">runner</span><span class="p">:</span>
<span class="o">[</span><span class="n">redacted</span><span class="o">]</span><span class="err">]</span>

<span class="n">Please</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">gitlab</span><span class="o">-</span><span class="n">ci</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="nl">runner</span><span class="p">:</span>
<span class="o">[</span><span class="n">my-runner</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="n">python</span><span class="o">-</span><span class="n">runner</span>

<span class="n">Please</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">gitlab</span><span class="o">-</span><span class="n">ci</span><span class="w"> </span><span class="n">tags</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">runner</span><span class="w"> </span><span class="p">(</span><span class="n">comma</span><span class="w"> </span><span class="n">separated</span><span class="p">)</span><span class="err">:</span>
<span class="n">python</span>
<span class="n">Registering</span><span class="w"> </span><span class="n">runner</span><span class="p">...</span><span class="w"> </span><span class="n">succeeded</span><span class="w">                     </span><span class="n">runner</span><span class="o">=</span><span class="mi">66</span><span class="n">m_339h</span>

<span class="n">Please</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nl">executor</span><span class="p">:</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">ssh</span><span class="o">+</span><span class="n">machine</span><span class="p">,</span><span class="w"> </span><span class="n">docker</span><span class="p">,</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">ssh</span><span class="p">,</span><span class="w"> </span><span class="n">parallels</span><span class="p">,</span><span class="w"> </span><span class="n">shell</span><span class="p">,</span><span class="w"> </span><span class="n">ssh</span><span class="p">,</span><span class="w"> </span><span class="n">virtualbox</span><span class="p">,</span><span class="w"> </span><span class="n">docker</span><span class="o">+</span><span class="n">machine</span><span class="p">,</span><span class="w"> </span><span class="nl">kubernetes</span><span class="p">:</span>
<span class="n">docker</span>

<span class="n">Please</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="nc">image</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="w"> </span><span class="nl">ruby</span><span class="p">:</span><span class="mf">2.1</span><span class="p">)</span><span class="err">:</span>
<span class="nl">alpine</span><span class="p">:</span><span class="n">latest</span>

<span class="n">Runner</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">successfully</span><span class="p">.</span><span class="w"> </span><span class="n">Feel</span><span class="w"> </span><span class="k">free</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="n">it</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">it</span><span class="err">'</span><span class="n">s</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">automatically</span><span class="w"> </span><span class="n">reloaded</span><span class="err">!</span>
</code></pre></div>
<p>My experience with Docker is limited, so I am using the latest alpine version. I'm sure there are better ones to use for a simple Python application, but this works for me and I'm not concerned about the absolute fastest CI/CD pipeline on my server.</p>
<h2 id="using-the-cicd-pipeline">Using the CI/CD pipeline<a class="headerlink" href="#using-the-cicd-pipeline" title="Permanent link">¶</a></h2>
<p>At this point, the GitLab runner is registered to a single project and is ready to use. You can enable your project to use this pipeline by adding a <code>.gitlab-ci.yml</code> file to the root of your repository.</p>
<p>I used it to set up the following pipeline.</p>
<p><img alt="Python - GitLab Pipeline" src="https://andrewwegner.com/images/gitlab-python-pipeline.png"/></p>
<p>This pipeline has 4 stages.</p>
<h3 id="static-analysis">Static Analysis<a class="headerlink" href="#static-analysis" title="Permanent link">¶</a></h3>
<p>In the Static Analysis phase, I run various analysis tools over my code. The goal here is to ensure that my code, YAML documents, and documentation are easy to read and use.</p>
<p>You'll notice the the xenon task has a warning in the image. I have the settings pretty strict in this pipeline, where I allow a very low <a href="https://radon.readthedocs.io/en/latest/intro.html#cyclomatic-complexity">Cyclomatic Complexity</a>. In this project, I have one function that is just barely failing my strict settings. I have allowed the pipeline to continue if this one particular task fails.</p>
<p>I could either increase the allowed complexity in the code base to ignore the warning. Alternatively, I could not allow the pipeline to proceed until I fix this function. This was one of those instances where it hasn't been worth it to refactor the code, but I want to be reminded I <em>should</em> fix it, so I allow the pipeline to proceed and show me the error.</p>
<h3 id="test">Test<a class="headerlink" href="#test" title="Permanent link">¶</a></h3>
<p>The Test phase should be fairly self explanatory. It's the stage where I run my test suite. It will only run if the Static Analysis phase completes successfully (or I allow a specific job to fail, in the case of the xenon task).</p>
<h3 id="deploy-testing">Deploy Testing<a class="headerlink" href="#deploy-testing" title="Permanent link">¶</a></h3>
<p>Once the test suite has completed successfully, I deploy the package to the test instance of PyPI. This ensures that I have a successful build and deploy.</p>
<h3 id="deploy-production">Deploy Production<a class="headerlink" href="#deploy-production" title="Permanent link">¶</a></h3>
<p>Deployment to production is a manual step. I did this because I don't always want to push changes to production PyPI. This is especially true if I'm only making small fixes - such as white space changes. I don't want to skip the entire CI process, but I also don't want to push out to production for something so minor.</p>
<h2 id="environment-set-up">Environment set up<a class="headerlink" href="#environment-set-up" title="Permanent link">¶</a></h2>
<p>One of my biggest complaints about the Travis CI integration with GitHub is how you <a href="https://andrewwegner.com/travisci-insecure-environment-variables.html">can't trust environment variables in Travis CI</a>. Since I control the server that this runner is connected to, I have no problem adding environment variables into GitLab.</p>
<p>In the project, I was able to add these by going to Settings-&gt;CI/CD and expanding the Variables section. I needed to store credentials for both the test and production instances of PyPI.</p>
<p><img alt="GitLab Environment Variables" src="https://andrewwegner.com/images/gitlab-env-variables.png"/></p>
<p>With these added, they are now accessible by my <code>.gitlab-ci.yml</code> file.</p>
<h3 id="gitlab-ciyml">.gitlab-ci.yml<a class="headerlink" href="#gitlab-ciyml" title="Permanent link">¶</a></h3>
<p>The script I use to build the pipeline is as follows:</p>
<div class="codehilight code"><pre><span></span><code><span class="n">image</span><span class="p">:</span><span class="w"> </span><span class="s2">"python:3.7"</span>

<span class="o">.</span><span class="n">python</span><span class="o">-</span><span class="n">tag</span><span class="p">:</span>
<span class="w">  </span><span class="n">tags</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">python</span>

<span class="n">before_script</span><span class="p">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="o">--</span><span class="n">version</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">.</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span>

<span class="n">stages</span><span class="p">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Static</span><span class="w"> </span><span class="n">Analysis</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Test</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="n">Testing</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="n">Production</span>

<span class="n">flake8</span><span class="p">:</span>
<span class="w">  </span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Static</span><span class="w"> </span><span class="n">Analysis</span>
<span class="w">  </span><span class="k">extends</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">.</span><span class="n">python</span><span class="o">-</span><span class="n">tag</span>
<span class="w">  </span><span class="n">script</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">flake8</span><span class="w"> </span><span class="o">--</span><span class="nb">max</span><span class="o">-</span><span class="n">line</span><span class="o">-</span><span class="n">length</span><span class="o">=</span><span class="mi">120</span>

<span class="n">doc8</span><span class="p">:</span>
<span class="w">  </span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Static</span><span class="w"> </span><span class="n">Analysis</span>
<span class="w">  </span><span class="k">extends</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">.</span><span class="n">python</span><span class="o">-</span><span class="n">tag</span>
<span class="w">  </span><span class="n">allow_failure</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span>
<span class="w">  </span><span class="n">script</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">doc8</span><span class="w"> </span><span class="o">--</span><span class="nb">max</span><span class="o">-</span><span class="n">line</span><span class="o">-</span><span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="w"> </span><span class="o">--</span><span class="n">ignore</span><span class="o">-</span><span class="n">path</span><span class="o">=</span><span class="n">docs</span><span class="o">/</span><span class="n">_build</span><span class="o">/*</span><span class="w"> </span><span class="n">docs</span><span class="o">/</span>

<span class="n">yamllint</span><span class="p">:</span>
<span class="w">  </span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Static</span><span class="w"> </span><span class="n">Analysis</span>
<span class="w">  </span><span class="k">extends</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">.</span><span class="n">python</span><span class="o">-</span><span class="n">tag</span>
<span class="w">  </span><span class="n">allow_failure</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span>
<span class="w">  </span><span class="n">script</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">yamllint</span><span class="w"> </span><span class="o">.</span>

<span class="n">bandit</span><span class="p">:</span>
<span class="w">  </span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Static</span><span class="w"> </span><span class="n">Analysis</span>
<span class="w">  </span><span class="k">extends</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">.</span><span class="n">python</span><span class="o">-</span><span class="n">tag</span>
<span class="w">  </span><span class="n">allow_failure</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span>
<span class="w">  </span><span class="n">script</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">bandit</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="n">B101</span><span class="w"> </span><span class="n">my_package</span>

<span class="n">radon</span><span class="p">:</span>
<span class="w">  </span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Static</span><span class="w"> </span><span class="n">Analysis</span>
<span class="w">  </span><span class="k">extends</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">.</span><span class="n">python</span><span class="o">-</span><span class="n">tag</span>
<span class="w">  </span><span class="n">script</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">radon</span><span class="w"> </span><span class="n">cc</span><span class="w"> </span><span class="n">my_package</span><span class="o">/</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="n">nb</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">radon</span><span class="w"> </span><span class="n">mi</span><span class="w"> </span><span class="n">my_package</span><span class="o">/</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="o">-</span><span class="n">nb</span>

<span class="n">xenon</span><span class="p">:</span>
<span class="w">  </span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Static</span><span class="w"> </span><span class="n">Analysis</span>
<span class="w">  </span><span class="k">extends</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">.</span><span class="n">python</span><span class="o">-</span><span class="n">tag</span>
<span class="w">  </span><span class="n">allow_failure</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span>
<span class="w">  </span><span class="n">script</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">xenon</span><span class="w"> </span><span class="o">--</span><span class="nb">max</span><span class="o">-</span><span class="n">absolute</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">--</span><span class="nb">max</span><span class="o">-</span><span class="n">modules</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">--</span><span class="nb">max</span><span class="o">-</span><span class="n">average</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">my_package</span><span class="o">/</span>

<span class="n">pytest</span><span class="p">:</span>
<span class="w">  </span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Test</span>
<span class="w">  </span><span class="k">extends</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">.</span><span class="n">python</span><span class="o">-</span><span class="n">tag</span>
<span class="w">  </span><span class="n">script</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">pytest</span>

<span class="n">deploy_testing</span><span class="p">:</span>
<span class="w">  </span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="n">Testing</span>
<span class="w">  </span><span class="k">extends</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">.</span><span class="n">python</span><span class="o">-</span><span class="n">tag</span>
<span class="w">  </span><span class="n">variables</span><span class="p">:</span>
<span class="w">    </span><span class="n">TWINE_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="n">PYPI_TEST_USERNAME</span>
<span class="w">    </span><span class="n">TWINE_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="n">PYPI_TEST_PASSWORD</span>
<span class="w">  </span><span class="n">script</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="n">setup</span><span class="o">.</span><span class="n">py</span><span class="w"> </span><span class="n">sdist</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">twine</span><span class="w"> </span><span class="n">upload</span><span class="w"> </span><span class="o">--</span><span class="n">repository</span><span class="o">-</span><span class="n">url</span><span class="w"> </span><span class="o">$</span><span class="n">PYPI_TEST_URL</span><span class="w"> </span><span class="n">dist</span><span class="o">/*</span>

<span class="n">deploy_production</span><span class="p">:</span>
<span class="w">  </span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="n">Production</span>
<span class="w">  </span><span class="k">extends</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">.</span><span class="n">python</span><span class="o">-</span><span class="n">tag</span>
<span class="w">  </span><span class="n">when</span><span class="p">:</span><span class="w"> </span><span class="n">manual</span>
<span class="w">  </span><span class="n">variables</span><span class="p">:</span>
<span class="w">    </span><span class="n">TWINE_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="n">PYPI_PROD_USERNAME</span>
<span class="w">    </span><span class="n">TWINE_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="n">PYPI_PROD_PASSWORD</span>
<span class="w">  </span><span class="n">script</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="n">setup</span><span class="o">.</span><span class="n">py</span><span class="w"> </span><span class="n">sdist</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">twine</span><span class="w"> </span><span class="n">upload</span><span class="w"> </span><span class="n">dist</span><span class="o">/*</span>
</code></pre></div>
<h2 id="gitlab-ciyml-explanation">.gitlab-ci.yml explanation<a class="headerlink" href="#gitlab-ciyml-explanation" title="Permanent link">¶</a></h2>
<p>There are a few areas that I feel need to be explained in the script above.</p>
<h3 id="tags">Tags<a class="headerlink" href="#tags" title="Permanent link">¶</a></h3>
<div class="codehilight code"><pre><span></span><code><span class="nl">.python-tag:</span>
<span class="w">  </span><span class="nl">tags:</span>
<span class="w">    </span><span class="err">-</span><span class="w"> </span><span class="nf">python</span>
</code></pre></div>
<p>This section is a template that is used to add the <code>python</code> tag to a job step. The Runner will only run tasks that have a tag you assigned to it. This is useful if you are building across multiple operating systems or across multiple languages. You don't want a runner set up to test against a Windows environment picking up tasks for a Linux environment. In my case, everything is being run for a single runner.</p>
<p>In each step, I need to add this:</p>
<div class="codehilight code"><pre><span></span><code>extends:
  - .python-tag
</code></pre></div>
<p>With this, the <code>python</code> tag will be automatically applied to the task. For a simple pipeline like mine, it may seem like overkill, but it's useful if I want to force other tags or steps.</p>
<h3 id="allow-failures">Allow failures<a class="headerlink" href="#allow-failures" title="Permanent link">¶</a></h3>
<div class="codehilight code"><pre><span></span><code><span class="n">xenon</span><span class="o">:</span>
<span class="w">  </span><span class="n">stage</span><span class="o">:</span><span class="w"> </span><span class="n">Static</span><span class="w"> </span><span class="n">Analysis</span>
<span class="w">  </span><span class="kd">extends</span><span class="o">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">.</span><span class="na">python</span><span class="o">-</span><span class="n">tag</span>
<span class="w">  </span><span class="n">allow_failure</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="n">script</span><span class="o">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">xenon</span><span class="w"> </span><span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">absolute</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">modules</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">average</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">my_package</span><span class="o">/</span>
</code></pre></div>
<p>I previously mentioned that I allowed the xenon step to fail. This is accomplished with the <code>allow_failue: true</code> setting you see here. Since this setting is in place, the pipeline will proceed even if this single task fails.</p>
<h3 id="manual-deployment">Manual deployment<a class="headerlink" href="#manual-deployment" title="Permanent link">¶</a></h3>
<div class="codehilight code"><pre><span></span><code><span class="n">deploy_production</span><span class="p">:</span>
<span class="w">  </span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="n">Production</span>
<span class="w">  </span><span class="k">extends</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">.</span><span class="n">python</span><span class="o">-</span><span class="n">tag</span>
<span class="w">  </span><span class="n">when</span><span class="p">:</span><span class="w"> </span><span class="n">manual</span>
<span class="w">  </span><span class="n">variables</span><span class="p">:</span>
<span class="w">    </span><span class="n">TWINE_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="n">PYPI_PROD_USERNAME</span>
<span class="w">    </span><span class="n">TWINE_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="n">PYPI_PROD_PASSWORD</span>
<span class="w">  </span><span class="n">script</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="n">setup</span><span class="o">.</span><span class="n">py</span><span class="w"> </span><span class="n">sdist</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">twine</span><span class="w"> </span><span class="n">upload</span><span class="w"> </span><span class="n">dist</span><span class="o">/*</span>
</code></pre></div>
<p>The deploy to production is a manual step. I use <code>when: manual</code> to ensure this step doesn't occur automatically. At some point in the future, this project will be stable and won't have minor fixes any longer and I'll want to automatically deploy to production without interaction. When I reach that point, I'll just need to remove this line. As long as the preceding steps succeed, this one will be performed as well.</p>
<h2 id="next-steps">Next Steps<a class="headerlink" href="#next-steps" title="Permanent link">¶</a></h2>
<p>Now that I've set this up and come to rely on it, I think my next steps will be converting my home Minecraft Server to use the GitLab pipelines to automatically deploy updates. Look for that post in the future.</p>
  </div>
<div class="neighbors">
  <a class="btn float-left" href="https://andrewwegner.com/invoiceninja-ubuntu-1804.html"
    title="Installing InvoiceNinja on Ubuntu 18.04">
    <i class="fa fa-angle-left"></i> Previous Post
  </a>
  <a class="btn float-right" href="https://andrewwegner.com/aws-certified-developer-review.html"
    title="Review of Ultimate AWS Certified Developer Associate 2019 course">
    Next Post <i class="fa fa-angle-right"></i>
  </a>
</div>
  <hr />
  <div>
            <span class="author_blurb"><a href="https://andrewwegner.com/about/" rel="author"><span class="author_name">Andy Wegner</span></a> -
             is a father, an engineer and a computer scientist. He is interested in online
            community building, tinkering with new code and building new applications.
            He writes about his experiences with each of these.</span>

  </div>


</article>

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Setting up GitLab runners",
  "headline": "Setting up GitLab runners",
  "dateCreated": "2019-10-22 11:00:00-05:00",
  "datePublished": "2019-10-22 11:00:00-05:00",
  "dateModified": "",
  "copyrightYear": "2019",
  "copyrightHolder": {
    "@type": "Person",
    "name": "Andy Wegner",
    "url": "https://andrewwegner.com"
  },
  "author": {
    "@type": "Person",
    "name": "Andy Wegner",
    "sameAs": [
      "https://www.andrewwegner.com/",
      "https://www.andrewwegner.com/about/",
      "https://www.andrewwegner.com/resume.pdf",
      "https://www.linkedin.com/in/andrew-wegner/",
      "https://github.com/AWegnerGitHub/",
      "https://stackoverflow.com/users/189134/andy",
      "https://keybase.io/awegner"
    ],
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://www.andrewwegner.com/about/"
      }
  },
  "publisher": {
    "@type": "Person",
    "name": "Andy Wegner",
    "sameAs": [
      "https://www.andrewwegner.com/",
      "https://www.andrewwegner.com/about/",
      "https://www.andrewwegner.com/resume.pdf",
      "https://www.linkedin.com/in/andrew-wegner/",
      "https://github.com/AWegnerGitHub/",
      "https://stackoverflow.com/users/189134/andy",
      "https://keybase.io/awegner"
    ]
  },
  "image": "/images/wegner_headshot.png",
  "url": "https://andrewwegner.com/setting-up-gitlab-runners.html",
  "description": "How I set up a GitLab runner",
  "mainEntityOfPage": "True",
  "articleSection": "Technical Solutions"
}
</script>
<footer>
<p>&copy; 2025 Andrew Wegner</p>
</footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Ponderings of an Andy ",
  "url" : "https://andrewwegner.com",
  "image": "/images/wegner_headshot.png",
  "description": "Articles and reviews covering thoughts on work place leadership, technical course reviews, and other ponderings of Andy Wegner"
}
</script>
</body>

</html>